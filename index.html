<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øª Ø±ÙˆÙ… Ú†Ù†Ø¯ Ù…Ù†Ø¸ÙˆØ±Ù‡</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Tahoma, sans-serif; background-color: #e5ddd5; height: 100vh; display: flex; flex-direction: column; }
        
        header { background: #075e54; color: white; padding: 10px; text-align: center; }
        
        /* Ø¨Ø®Ø´ Ø§Ù†ØªØ®Ø§Ø¨ Ø§ØªØ§Ù‚ */
        .room-selector { background: #128c7e; color: white; padding: 10px; display: flex; justify-content: center; gap: 10px; font-size: 13px; }
        select { padding: 5px; border-radius: 5px; border: none; outline: none; background: white; color: #075e54; font-weight: bold; }

        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; padding-bottom: 80px; }
        .message { padding: 10px; border-radius: 12px; max-width: 80%; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 14px; }
        .mine { background: #dcf8c6; align-self: flex-end; border-top-left-radius: 2px; }
        .others { background: white; align-self: flex-start; border-top-right-radius: 2px; }
        .user-name { font-size: 11px; color: #128c7e; font-weight: bold; display: block; }
        .delete-btn { display: none; background: none; border: none; color: #e74c3c; font-size: 11px; cursor: pointer; margin-top: 5px; }
        .mine .delete-btn { display: inline-block; }

        .input-area { position: fixed; bottom: 0; width: 100%; background: #f0f0f0; padding: 10px; display: flex; gap: 10px; }
        #userInput { width: 65px; border-radius: 15px; border: 1px solid #ddd; padding: 5px; font-size: 12px; }
        #messageInput { flex: 1; border-radius: 25px; border: none; padding: 10px; outline: none; }
        button#sendBtn { background: #128c7e; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 20px; }
    </style>
</head>
<body>

<header>Ú†Øª Ø±ÙˆÙ… Ù‡ÙˆØ´Ù…Ù†Ø¯</header>

<div class="room-selector">
    <span>Ø§Ù†ØªØ®Ø§Ø¨ Ø§ØªØ§Ù‚:</span>
    <select id="roomSelect" onchange="loadMessages()">
        <option value="general">Ø¹Ù…ÙˆÙ…ÛŒ ğŸŒ</option>
        <option value="friends">Ø¯ÙˆØ³ØªØ§Ù† ğŸ‘¥</option>
        <option value="games">Ú¯ÛŒÙ… ğŸ®</option>
    </select>
</div>

<div id="messages"></div>

<div class="input-area">
    <input type="text" id="userInput" placeholder="Ù†Ø§Ù…">
    <input type="text" id="messageInput" placeholder="Ù¾ÛŒØ§Ù…...">
    <button id="sendBtn" onclick="sendMessage()">âœˆ</button>
</div>

<script>
    // --- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÙˆÙ¾Ø§Ø¨ÛŒØ³ Ø®ÙˆØ¯Øª Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú¯Ø°Ø§Ø± ---
    const SUPABASE_URL = 'https://nefnjochiaowqsojvaxf.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_JPylE5aN3KRD5R53C6EnPg_uPJlTiEv';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    if(!localStorage.getItem('chat_user_id')) {
        localStorage.setItem('chat_user_id', 'u-' + Math.random().toString(36).substr(2, 9));
    }
    const myID = localStorage.getItem('chat_user_id');

    async function loadMessages() {
        const currentRoom = document.getElementById('roomSelect').value;
        
        // ÙÙ‚Ø· Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒÛŒ Ø±Ø§ Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ… Ú©Ù‡ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ØªØ§Ù‚ ÙØ¹Ù„ÛŒ Ù‡Ø³ØªÙ†Ø¯
        const { data, error } = await _supabase
            .from('messages')
            .select('*')
            .eq('room_name', currentRoom) // ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ø§ØªØ§Ù‚
            .order('created_at', { ascending: true });

        if (error) return;

        const container = document.getElementById('messages');
        container.innerHTML = data.map(m => `
            <div class="message ${m.sender_id === myID ? 'mine' : 'others'}">
                <span class="user-name">${m.user_name}</span>
                ${m.message_text}
                <br>
                <button class="delete-btn" onclick="deleteMessage(${m.id})">ğŸ—‘ Ø­Ø°Ù</button>
            </div>
        `).join('');
        container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
        const user = document.getElementById('userInput').value || 'Ù†Ø§Ø´Ù†Ø§Ø³';
        const text = document.getElementById('messageInput').value;
        const currentRoom = document.getElementById('roomSelect').value;
        if (!text) return;

        await _supabase.from('messages').insert([
            { user_name: user, message_text: text, sender_id: myID, room_name: currentRoom }
        ]);

        document.getElementById('messageInput').value = '';
        loadMessages();
    }

    async function deleteMessage(id) {
        if(confirm('Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')) {
            await _supabase.from('messages').delete().eq('id', id);
            loadMessages();
        }
    }

    setInterval(loadMessages, 3000);
    loadMessages();
</script>

</body>
</html>
